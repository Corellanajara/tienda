<script type="text/javascript" src="{{theme}}/js/jquery-1.8.2.min.js"></script> {# LLAMADA A JQUERY #}
<script src="{{theme}}/js/modernizr.custom.12319.js"></script> {# MODERNIZR #}
<!-- JQUERY UI -->
<script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script> <!-- jQuery UI -->  
<script src="{{theme}}/js/albatronic.js"></script>
<script src="{{theme}}/js/pirobox_extended.js"></script>
<script src="{{theme}}/js/pirobox_function.js"></script> {# pirobox #}
<!-- SLIDER HOME -->
<script src="{{theme}}/js/bjqs-1.3.min.js"></script>
<script src="{{theme}}/js/bjqs-function.js"></script>
<script src="{{theme}}/js/jcarousellite.js" type="text/javascript"></script>
<script src="//use.edgefonts.net/open-sans.js"></script>
<script>
var combinaciones = {{values.combinacionesJSON|raw}};

$(function(){
    $('#zonaEnvio').change(function(){
        html = "";
        zona = $('#zonaEnvio').val();
        fp = "";        
        $.each(combinaciones[zona],function(key,value){
            $.each(value,function(k,v){ formaPago = v['formaPago']});
            html = html + "<option value="+key+">"+formaPago+"</option>";
        });
        $('#formaPago option').remove();
        $('#formaPago').append(html);
        $('#formaPago').change();
    });
    
    $('#formaPago').change(function(){
        html = "";
        zona = $('#zonaEnvio').val();
        fp = $('#formaPago').val();        
        $.each(combinaciones[zona][fp],function(key,value){
            html = html + "<option value="+key+">"+value.agencia+"</option>";            
        });
        $('#metodoEnvio option').remove();
        $('#metodoEnvio').append(html);
        $('#metodoEnvio').change();
    });
    
    $('#metodoEnvio').change(function(){
        zona = $('#zonaEnvio').val();
        fp = $('#formaPago').val();
        gastos = combinaciones[zona][fp][$(this).val()]['gastos'];
        plazoEntrega = combinaciones[zona][fp][$(this).val()]['plazoEntrega'];
        updateGastos(gastos,plazoEntrega);       
    });
});

/**
 * Refresca los texto de gastos y plazo de entrega
 * @param string gastos
 * @param string plazoEntrega
 * @returns void
 */
function updateGastos(gastos,plazoEntrega) {
    $('#gastosEnvio').html(gastos);
    $('#plazoEntrega').html(plazoEntrega);
}

/**
 * Actualiza la línea de carrito idLinea
 * @param integer idLinea
 * @returns void
 */
function actualizar(idLinea) {
    if ($('#unidades'+idLinea).val()<=0) return;

    var datos = {
        'IDLinea' : idLinea,
        'Unidades' : $('#unidades'+idLinea).val()
    }

    $.ajax({
        url: appPath + '/lib/carrito.php',
        dataType: 'html',
        type: 'post',
        data: {'parametros': {'accion': 'update', 'datos': datos} },
        success: function(resultado) {
            var datos = $.parseJSON(resultado);  
            if (datos.status === 'error') {
                $('#mensajes').html(datos.errores);
                $('#mensajes').dialog('open');
            } else {
                $('#importe'+idLinea).html(datos.linea.Importe);
                $('#total').html(datos.totales.Importe);
            }
        }
    });        
}

/**
 * Elimina la línea del carrito idLinea
 * @param integer idLinea
 * @returns void
 */
function eliminar(idLinea) {
    if (!confirm('{{macro.idioma('deseaEliminarDeLaCestaElProducto')}}')) return;

    var datos = {
        'IDLinea' : idLinea
    }

    $.ajax({
        url: appPath + '/lib/carrito.php',
        dataType: 'html',
        type: 'post',
        data: {'parametros': {'accion': 'remove', 'datos': datos} },
        success: function(resultado) {
            var datos = $.parseJSON(resultado);  
            if (datos.status === 'error') {
                $('#mensajes').html(datos.errores);
                $('#mensajes').dialog('open');
            } else {
                $('#linea'+idLinea).remove();
                if (datos.totales.Unidades !== null) {
                    $('#total').html(datos.totales.Importe);
                } else {
                    window.location.href = "{{app.path}}/carrito";                        
                }
            }
        }
    });         
}
</script>